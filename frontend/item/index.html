<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inscription | Basescriptions</title>
  <style>
    :root {
      --bg: #0a0a0a;
      --bg2: #141414;
      --bg-preview: #e8e8e8;
      --border: #2a2a2a;
      --text: #e0e0e0;
      --text2: #888;
      --accent: #0052FF;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 20px; }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 40px;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 24px;
      font-weight: bold;
      color: var(--text);
      text-decoration: none;
    }
    .logo-icon {
      width: 40px;
      height: 40px;
      background: var(--accent);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
    }
    nav { display: flex; gap: 24px; }
    nav a { color: var(--text2); text-decoration: none; font-size: 14px; }
    nav a:hover { color: var(--text); }

    .item-layout {
      display: flex;
      gap: 48px;
      align-items: flex-start;
    }

    .preview-box {
      width: 400px;
      min-height: 400px;
      background: var(--bg-preview);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      flex-shrink: 0;
    }
    .preview-box iframe {
      width: 100%;
      height: 400px;
      border: none;
    }
    .preview-box img {
      max-width: 100%;
      max-height: 400px;
    }
    .preview-text {
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 24px;
      color: #333;
      text-align: center;
      padding: 40px;
      word-break: break-all;
    }

    .item-details {
      flex: 1;
    }
    .item-title {
      font-size: 36px;
      font-weight: 800;
      margin-bottom: 32px;
      color: #fff;
    }

    .meta-table {
      width: 100%;
    }
    .meta-row {
      display: flex;
      padding: 20px 0;
      border-bottom: 1px solid var(--border);
    }
    .meta-row:last-child { border-bottom: none; }
    .meta-label {
      width: 200px;
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
    }
    .meta-value {
      flex: 1;
      font-size: 15px;
      color: var(--text2);
      word-break: break-all;
    }
    .meta-value a {
      color: var(--accent);
      text-decoration: none;
    }
    .meta-value a:hover { text-decoration: underline; }

    .activity-section {
      margin-top: 48px;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
    }
    .activity-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 20px;
    }
    .activity-table {
      width: 100%;
      border-collapse: collapse;
    }
    .activity-table th {
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: var(--text2);
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }
    .activity-table td {
      padding: 16px 0;
      font-size: 14px;
      border-bottom: 1px solid var(--border);
    }
    .activity-table tr:last-child td { border-bottom: none; }
    .event-badge {
      display: inline-block;
      padding: 6px 12px;
      background: rgba(48, 224, 0, 0.15);
      color: #30E000;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
    }
    .event-badge.transfer {
      background: rgba(0, 82, 255, 0.15);
      color: var(--accent);
    }

    .loading { text-align: center; padding: 100px; color: var(--text2); font-size: 18px; }
    .error { text-align: center; padding: 100px; color: #ff4444; font-size: 18px; }

    @media (max-width: 900px) {
      .item-layout {
        flex-direction: column;
      }
      .preview-box {
        width: 100%;
        min-height: 300px;
      }
      .preview-box iframe { height: 300px; }
      .meta-label { width: 140px; }
      .item-title { font-size: 28px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <a href="/" class="logo">
        <div class="logo-icon">B</div>
        <span>Basescriptions</span>
      </a>
      <nav>
        <a href="/register/">Register</a>
        <a href="/upload/">Upload</a>
      </nav>
    </header>

    <div id="content">
      <div class="loading">Loading inscription...</div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://basescriptions-api.wrapit.workers.dev';

    // Get ID from URL path or query params
    const params = new URLSearchParams(window.location.search);
    const pathParts = window.location.pathname.split('/').filter(p => p && p !== 'item' && p !== 'view');
    let id = pathParts[pathParts.length - 1] || params.get('id') || params.get('hash') || params.get('tx');

    if (!id) {
      document.getElementById('content').innerHTML = '<div class="error">No inscription ID provided</div>';
    } else {
      loadInscription(id);
    }

    async function loadInscription(id) {
      try {
        let res = await fetch(`${API_BASE}/hash/${id}`);
        let data = await res.json();

        if (data.error) {
          // Try as transaction hash
          const rpcRes = await fetch('https://mainnet.base.org', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              jsonrpc: '2.0', id: 1,
              method: 'eth_getTransactionByHash',
              params: [id]
            })
          });
          const rpcData = await rpcRes.json();
          if (rpcData.result) {
            const hash = await sha256(rpcData.result.input.toLowerCase());
            res = await fetch(`${API_BASE}/hash/${hash}`);
            data = await res.json();
          }
        }

        if (data.error) {
          document.getElementById('content').innerHTML = '<div class="error">Inscription not found</div>';
          return;
        }

        renderInscription(data);
      } catch (e) {
        console.error(e);
        document.getElementById('content').innerHTML = '<div class="error">Error loading inscription</div>';
      }
    }

    function renderInscription(data) {
      const content = data.content_uri || '';
      const isName = content.startsWith('data:,') && /^[a-z0-9-]+$/.test(content.replace('data:,', ''));
      const nameText = content.replace(/^data:[^,]*,/, '');
      const displayTitle = isName ? nameText : `Block ${data.creation_block?.toLocaleString()}`;
      const created = timeAgo(data.creation_timestamp || data.created_at);

      document.title = `${displayTitle} | Basescriptions`;

      // Preview
      let preview = '';
      if (content.startsWith('data:image/')) {
        preview = `<img src="${content}" alt="Inscription">`;
      } else if (content.startsWith('data:text/html') || content.includes('base64')) {
        preview = `<iframe src="${content}"></iframe>`;
      } else {
        preview = `<div class="preview-text">${escapeHtml(nameText)}</div>`;
      }

      const html = `
        <div class="item-layout">
          <div class="preview-box">${preview}</div>

          <div class="item-details">
            <h1 class="item-title">${escapeHtml(displayTitle)}</h1>

            <div class="meta-table">
              <div class="meta-row">
                <div class="meta-label">Mimetype</div>
                <div class="meta-value">${data.content_type || 'text/plain'}</div>
              </div>
              <div class="meta-row">
                <div class="meta-label">Block</div>
                <div class="meta-value">${data.creation_block?.toLocaleString()}</div>
              </div>
              <div class="meta-row">
                <div class="meta-label">Owner</div>
                <div class="meta-value"><a href="/${data.current_owner}">${data.current_owner?.slice(0,6)}...${data.current_owner?.slice(-4)}</a></div>
              </div>
              <div class="meta-row">
                <div class="meta-label">Creator</div>
                <div class="meta-value"><a href="/${data.creator}">${data.creator?.slice(0,6)}...${data.creator?.slice(-4)}</a></div>
              </div>
              <div class="meta-row">
                <div class="meta-label">Created</div>
                <div class="meta-value">${created}</div>
              </div>
              <div class="meta-row">
                <div class="meta-label">Transaction</div>
                <div class="meta-value"><a href="https://basescan.org/tx/${data.creation_tx}" target="_blank">${data.creation_tx?.slice(0,12)}...${data.creation_tx?.slice(-8)}</a></div>
              </div>
              <div class="meta-row">
                <div class="meta-label">Hash</div>
                <div class="meta-value">${data.id?.slice(0,12)}...${data.id?.slice(-8)}</div>
              </div>
            </div>
          </div>
        </div>

        <div class="activity-section">
          <h2 class="activity-title">Activity</h2>
          <table class="activity-table">
            <thead>
              <tr>
                <th>Event</th>
                <th>From</th>
                <th>To</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><span class="event-badge">Create</span></td>
                <td>-</td>
                <td><a href="/${data.creator}">${data.creator?.slice(0,6)}...${data.creator?.slice(-4)}</a></td>
                <td>${created}</td>
              </tr>
              ${(data.transfers || []).map(t => `
                <tr>
                  <td><span class="event-badge transfer">Transfer</span></td>
                  <td><a href="/${t.from_address}">${t.from_address?.slice(0,6)}...${t.from_address?.slice(-4)}</a></td>
                  <td><a href="/${t.to_address}">${t.to_address?.slice(0,6)}...${t.to_address?.slice(-4)}</a></td>
                  <td>${timeAgo(t.timestamp)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      document.getElementById('content').innerHTML = html;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    function timeAgo(date) {
      if (!date) return 'Unknown';
      const seconds = Math.floor((new Date() - new Date(date)) / 1000);
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
      return Math.floor(seconds / 86400) + ' days ago';
    }

    async function sha256(input) {
      const data = new TextEncoder().encode(input);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return '0x' + Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
    }
  </script>
</body>
</html>
