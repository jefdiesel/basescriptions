<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inscription | Basescriptions</title>
  <style>
    :root {
      --bg: #0a0a0a;
      --bg2: #141414;
      --bg-preview: #e8e8e8;
      --border: #2a2a2a;
      --text: #e0e0e0;
      --text2: #888;
      --accent: #0052FF;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 20px; }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 40px;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 24px;
      font-weight: bold;
      color: var(--text);
      text-decoration: none;
    }
    .logo-icon {
      width: 40px;
      height: 40px;
      background: var(--accent);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
    }
    nav { display: flex; gap: 24px; }
    nav a { color: var(--text2); text-decoration: none; font-size: 14px; }
    nav a:hover { color: var(--text); }

    .item-layout {
      display: flex;
      gap: 48px;
      align-items: flex-start;
    }

    .preview-box {
      width: 400px;
      min-height: 400px;
      background: var(--bg-preview);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      flex-shrink: 0;
    }
    .preview-box iframe {
      width: 100%;
      height: 400px;
      border: none;
    }
    .preview-box img {
      max-width: 100%;
      max-height: 400px;
    }
    .preview-box img.pixel-art {
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    .preview-text {
      font-family: 'SF Mono', Monaco, 'Courier New', monospace;
      font-size: 24px;
      color: #333;
      text-align: center;
      padding: 40px;
      word-break: break-all;
    }

    .item-details {
      flex: 1;
    }
    .item-title {
      font-size: 36px;
      font-weight: 800;
      margin-bottom: 32px;
      color: #fff;
    }

    .meta-table {
      width: 100%;
    }
    .meta-row {
      display: flex;
      padding: 20px 0;
      border-bottom: 1px solid var(--border);
    }
    .meta-row:last-child { border-bottom: none; }
    .meta-label {
      width: 200px;
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
    }
    .meta-value {
      flex: 1;
      font-size: 15px;
      color: var(--text2);
      word-break: break-all;
    }
    .meta-value a {
      color: var(--accent);
      text-decoration: none;
    }
    .meta-value a:hover { text-decoration: underline; }

    .activity-section {
      margin-top: 48px;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
    }
    .activity-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 20px;
    }
    .activity-table {
      width: 100%;
      border-collapse: collapse;
    }
    .activity-table th {
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: var(--text2);
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }
    .activity-table td {
      padding: 16px 0;
      font-size: 14px;
      border-bottom: 1px solid var(--border);
    }
    .activity-table tr:last-child td { border-bottom: none; }
    .event-badge {
      display: inline-block;
      padding: 6px 12px;
      background: rgba(48, 224, 0, 0.15);
      color: #30E000;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
    }
    .event-badge.transfer {
      background: rgba(0, 82, 255, 0.15);
      color: var(--accent);
    }

    .loading { text-align: center; padding: 100px; color: var(--text2); font-size: 18px; }
    .error { text-align: center; padding: 100px; color: #ff4444; font-size: 18px; }

    .transfer-btn {
      display: none;
      margin-top: 24px;
      padding: 14px 28px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .transfer-btn:hover { opacity: 0.9; }
    .transfer-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      max-width: 450px;
      width: 90%;
    }
    .modal h3 {
      font-size: 20px;
      margin-bottom: 20px;
    }
    .modal input {
      width: 100%;
      padding: 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
      margin-bottom: 16px;
    }
    .modal input:focus {
      outline: none;
      border-color: var(--accent);
    }
    .modal-buttons {
      display: flex;
      gap: 12px;
    }
    .modal-buttons button {
      flex: 1;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }
    .modal-cancel {
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border) !important;
    }
    .modal-confirm {
      background: var(--accent);
      color: #fff;
    }
    .modal-error {
      color: #ff4444;
      font-size: 13px;
      margin-bottom: 12px;
    }

    @media (max-width: 900px) {
      .item-layout {
        flex-direction: column;
      }
      .preview-box {
        width: 100%;
        min-height: 300px;
      }
      .preview-box iframe { height: 300px; }
      .meta-label { width: 140px; }
      .item-title { font-size: 28px; }
    }

    /* Hamburger Menu */
    .hamburger {
      display: none;
      flex-direction: column;
      gap: 5px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      z-index: 101;
    }
    .hamburger span {
      display: block;
      width: 24px;
      height: 2px;
      background: var(--text);
      transition: all 0.3s;
    }
    .hamburger.active span:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }
    .hamburger.active span:nth-child(2) {
      opacity: 0;
    }
    .hamburger.active span:nth-child(3) {
      transform: rotate(-45deg) translate(5px, -5px);
    }

    .mobile-nav {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg);
      z-index: 100;
      flex-direction: column;
      padding: 80px 24px 24px;
    }
    .mobile-nav.active { display: flex; }
    .mobile-nav a {
      display: block;
      padding: 16px 0;
      color: var(--text);
      text-decoration: none;
      font-size: 20px;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
    }

    @media (max-width: 600px) {
      .container { padding: 16px; }
      header { padding: 16px 0; margin-bottom: 24px; }
      .logo { font-size: 20px; }
      .logo-icon { width: 32px; height: 32px; }
      nav { display: none; }
      .hamburger { display: flex; }
      .preview-box { min-height: 250px; border-radius: 12px; }
      .preview-box iframe { height: 250px; }
      .preview-text { font-size: 18px; padding: 24px; }
      .item-title { font-size: 24px; margin-bottom: 20px; }
      .meta-row { padding: 14px 0; }
      .meta-label { width: 100px; font-size: 13px; }
      .meta-value { font-size: 13px; }
      .activity-section { padding: 16px; margin-top: 32px; }
      .activity-title { font-size: 18px; }
      .activity-table th, .activity-table td { font-size: 12px; padding: 10px 0; }
      .event-badge { padding: 4px 8px; font-size: 11px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <a href="/" class="logo">
        <div class="logo-icon">B</div>
        <span>Basescriptions</span>
      </a>
      <nav>
        <a href="/register/">Register a Name</a>
        <a href="/inscribe/">Inscribe</a>
        <a href="/upload/">Upload Site</a>
      </nav>
      <button class="hamburger" id="hamburger">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </header>

    <div class="mobile-nav" id="mobileNav">
      <a href="/">Home</a>
      <a href="/register/">Register a Name</a>
      <a href="/inscribe/">Inscribe</a>
      <a href="/upload/">Upload Site</a>
    </div>

    <div id="content">
      <div class="loading">Loading inscription...</div>
    </div>
  </div>

  <!-- Transfer Modal -->
  <div class="modal-overlay" id="transferModal">
    <div class="modal">
      <h3>Transfer Inscription</h3>
      <div class="modal-error" id="transferError" style="display:none;"></div>
      <input type="text" id="transferTo" placeholder="Destination address (0x...)" />
      <div class="modal-buttons">
        <button class="modal-cancel" onclick="closeTransferModal()">Cancel</button>
        <button class="modal-confirm" id="confirmTransferBtn" onclick="confirmTransfer()">Transfer</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://basescriptions-api.wrapit.workers.dev';
    const BASE_CHAIN_ID = '0x2105';
    let inscriptionData = null;
    let connectedAddress = null;

    // Get ID from URL path or query params
    const params = new URLSearchParams(window.location.search);
    const pathParts = window.location.pathname.split('/').filter(p => p && p !== 'item' && p !== 'view');
    let id = pathParts[pathParts.length - 1] || params.get('id') || params.get('hash') || params.get('tx');

    // Clean up URL if we have ?id= param - replace with clean path
    if (id && params.get('id') && window.location.pathname === '/item/') {
      history.replaceState(null, '', '/item/' + id);
    }

    if (!id) {
      document.getElementById('content').innerHTML = '<div class="error">No inscription ID provided</div>';
    } else {
      loadInscription(id);
      checkWalletConnection();
    }

    async function checkWalletConnection() {
      if (!window.ethereum) return;
      try {
        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
        if (accounts && accounts[0]) {
          connectedAddress = accounts[0].toLowerCase();
          updateTransferButton();
        }
      } catch (e) {}
    }

    function updateTransferButton() {
      const btn = document.getElementById('transferBtn');
      if (btn && inscriptionData && connectedAddress) {
        if (inscriptionData.current_owner?.toLowerCase() === connectedAddress) {
          btn.style.display = 'inline-block';
        }
      }
    }

    async function loadInscription(id) {
      try {
        let res = await fetch(`${API_BASE}/hash/${id}`);
        let data = await res.json();

        if (data.error) {
          // Try as transaction hash
          const rpcRes = await fetch('https://mainnet.base.org', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              jsonrpc: '2.0', id: 1,
              method: 'eth_getTransactionByHash',
              params: [id]
            })
          });
          const rpcData = await rpcRes.json();
          if (rpcData.result) {
            const hash = await sha256(rpcData.result.input.toLowerCase());
            res = await fetch(`${API_BASE}/hash/${hash}`);
            data = await res.json();
          }
        }

        if (data.error) {
          document.getElementById('content').innerHTML = '<div class="error">Inscription not found</div>';
          return;
        }

        // Fetch full calldata from chain (database may truncate)
        if (data.creation_tx) {
          const rpcRes = await fetch('https://mainnet.base.org', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              jsonrpc: '2.0', id: 1,
              method: 'eth_getTransactionByHash',
              params: [data.creation_tx]
            })
          });
          const rpcData = await rpcRes.json();
          if (rpcData.result && rpcData.result.input) {
            data.content_uri = parseCalldata(rpcData.result.input);
          }
        }

        inscriptionData = data;
        renderInscription(data);
        updateTransferButton();
      } catch (e) {
        console.error(e);
        document.getElementById('content').innerHTML = '<div class="error">Error loading inscription</div>';
      }
    }

    function parseCalldata(input) {
      if (!input || input === '0x') return '';
      const hex = input.startsWith('0x') ? input.slice(2) : input;
      const bytes = new Uint8Array(hex.match(/.{1,2}/g).map(b => parseInt(b, 16)));
      return new TextDecoder('utf-8', { fatal: false }).decode(bytes);
    }

    function renderInscription(data) {
      const content = data.content_uri || '';
      const isName = content.startsWith('data:,') && /^[a-z0-9-]+$/.test(content.replace('data:,', ''));
      const nameText = content.replace(/^data:[^,]*,/, '');
      const displayTitle = isName ? nameText : `Inscription #${data.inscription_number || '?'}`;
      const created = timeAgo(data.creation_timestamp || data.created_at);

      document.title = `${displayTitle} | Basescriptions`;

      // Preview
      let preview = '';
      if (content.startsWith('data:image/')) {
        const isPixelArt = content.includes('pixelart=1');
        const pixelClass = isPixelArt ? 'pixel-art' : '';
        preview = `<img src="${content}" alt="Inscription" class="${pixelClass}">`;
      } else if (content.startsWith('data:text/html')) {
        preview = `<iframe src="${content}" sandbox="allow-scripts allow-same-origin"></iframe>`;
      } else {
        preview = `<div class="preview-text">${escapeHtml(nameText)}</div>`;
      }

      const html = `
        <div class="item-layout">
          <div class="preview-box">${preview}</div>

          <div class="item-details">
            <h1 class="item-title">${escapeHtml(displayTitle)}</h1>

            <div class="meta-table">
              <div class="meta-row">
                <div class="meta-label">Mimetype</div>
                <div class="meta-value">${data.content_type || 'text/plain'}</div>
              </div>
              <div class="meta-row">
                <div class="meta-label">Block</div>
                <div class="meta-value">${data.creation_block?.toLocaleString()}</div>
              </div>
              <div class="meta-row">
                <div class="meta-label">Owner</div>
                <div class="meta-value"><a href="/${data.current_owner}">${data.current_owner?.slice(0,6)}...${data.current_owner?.slice(-4)}</a></div>
              </div>
              <div class="meta-row">
                <div class="meta-label">Creator</div>
                <div class="meta-value"><a href="/${data.creator}">${data.creator?.slice(0,6)}...${data.creator?.slice(-4)}</a></div>
              </div>
              <div class="meta-row">
                <div class="meta-label">Created</div>
                <div class="meta-value">${created}</div>
              </div>
              <div class="meta-row">
                <div class="meta-label">Transaction</div>
                <div class="meta-value"><a href="https://basescan.org/tx/${data.creation_tx}" target="_blank">${data.creation_tx?.slice(0,12)}...${data.creation_tx?.slice(-8)}</a></div>
              </div>
              <div class="meta-row">
                <div class="meta-label">Hash</div>
                <div class="meta-value">${data.id?.slice(0,12)}...${data.id?.slice(-8)}</div>
              </div>
            </div>

            <button class="transfer-btn" id="transferBtn" onclick="openTransferModal()">Transfer</button>
          </div>
        </div>

        <div class="activity-section">
          <h2 class="activity-title">Activity</h2>
          <table class="activity-table">
            <thead>
              <tr>
                <th>Event</th>
                <th>From</th>
                <th>To</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><span class="event-badge">Create</span></td>
                <td>-</td>
                <td><a href="/${data.creator}">${data.creator?.slice(0,6)}...${data.creator?.slice(-4)}</a></td>
                <td>${created}</td>
              </tr>
              ${(data.transfers || []).map(t => `
                <tr>
                  <td><span class="event-badge transfer">Transfer</span></td>
                  <td><a href="/${t.from_address}">${t.from_address?.slice(0,6)}...${t.from_address?.slice(-4)}</a></td>
                  <td><a href="/${t.to_address}">${t.to_address?.slice(0,6)}...${t.to_address?.slice(-4)}</a></td>
                  <td>${timeAgo(t.timestamp)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;

      document.getElementById('content').innerHTML = html;

    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    function timeAgo(date) {
      if (!date) return 'Unknown';
      const seconds = Math.floor((new Date() - new Date(date)) / 1000);
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
      return Math.floor(seconds / 86400) + ' days ago';
    }

    async function sha256(input) {
      const data = new TextEncoder().encode(input);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return '0x' + Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Transfer functions
    function openTransferModal() {
      document.getElementById('transferModal').classList.add('active');
      document.getElementById('transferTo').value = '';
      document.getElementById('transferError').style.display = 'none';
    }

    function closeTransferModal() {
      document.getElementById('transferModal').classList.remove('active');
    }

    async function confirmTransfer() {
      const toAddress = document.getElementById('transferTo').value.trim();
      const errorEl = document.getElementById('transferError');
      const confirmBtn = document.getElementById('confirmTransferBtn');

      // Validate address
      if (!toAddress || !/^0x[a-fA-F0-9]{40}$/.test(toAddress)) {
        errorEl.textContent = 'Please enter a valid Ethereum address';
        errorEl.style.display = 'block';
        return;
      }

      if (toAddress.toLowerCase() === connectedAddress) {
        errorEl.textContent = 'Cannot transfer to yourself';
        errorEl.style.display = 'block';
        return;
      }

      errorEl.style.display = 'none';
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'Connecting...';

      try {
        // Connect wallet if needed
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        const account = accounts[0];

        // Check chain
        confirmBtn.textContent = 'Checking network...';
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        if (chainId !== BASE_CHAIN_ID) {
          confirmBtn.textContent = 'Switch to Base...';
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: BASE_CHAIN_ID }]
          });
          await new Promise(r => setTimeout(r, 500));
        }

        // Send transfer tx - data is the inscription hash
        confirmBtn.textContent = 'Confirm in wallet...';

        // Validate inscription data
        if (!inscriptionData || !inscriptionData.id) {
          throw new Error('Inscription data not loaded');
        }

        const inscriptionHash = inscriptionData.id;
        console.log('Transferring inscription:', inscriptionHash);
        console.log('From:', account);
        console.log('To:', toAddress);

        const txHash = await window.ethereum.request({
          method: 'eth_sendTransaction',
          params: [{
            from: account,
            to: toAddress,
            data: inscriptionHash,
            value: '0x0'
          }]
        });

        // Update database
        console.log('Updating DB with transfer:', { hash: inscriptionHash, from: account, to: toAddress, tx_hash: txHash });
        try {
          const transferRes = await fetch(`${API_BASE}/transfer`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              hash: inscriptionHash,
              from: account,
              to: toAddress,
              tx_hash: txHash
            })
          });
          const transferData = await transferRes.json();
          console.log('Transfer API response:', transferData);
        } catch (e) {
          console.log('DB transfer error (will be indexed later):', e);
        }

        closeTransferModal();
        alert('Transfer successful! TX: ' + txHash);
        window.location.reload();

      } catch (e) {
        console.error('Transfer error:', e);
        errorEl.textContent = e.message || 'Transfer failed';
        errorEl.style.display = 'block';
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Transfer';
      }
    }

    // Hamburger menu
    const hamburger = document.getElementById('hamburger');
    const mobileNav = document.getElementById('mobileNav');

    hamburger.addEventListener('click', () => {
      hamburger.classList.toggle('active');
      mobileNav.classList.toggle('active');
    });
  </script>
</body>
</html>
